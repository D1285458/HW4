const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');
const path = require('path');

// 資料庫檔案路徑
const dbPath = path.join(__dirname, 'db', 'sqlite.db');

// 確保資料庫目錄存在
const dbDir = path.dirname(dbPath);
if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
}

// 開啟資料庫
const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('無法開啟資料庫:', err.message);
    } else {
        console.log('成功連接到 SQLite 資料庫');
    }
});

// 修改 starbucks 資料表結構
const createTableQuery = `CREATE TABLE IF NOT EXISTS starbucks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    price REAL NOT NULL,
    size TEXT CHECK(size IN ('中杯', '大杯', '特大杯')) NOT NULL,
    time TEXT NOT NULL
)`;

db.serialize(() => {
    db.run(`DROP TABLE IF EXISTS starbucks`, (err) => {
        if (err) {
            console.error('無法刪除舊的 starbucks 資料表:', err.message);
        } else {
            console.log('舊的 starbucks 資料表已刪除');
            db.run(createTableQuery, (err) => {
                if (err) {
                    console.error('無法建立新的 starbucks 資料表:', err.message);
                } else {
                    console.log('成功建立新的 starbucks 資料表');

                    // 確保在資料表建立後插入資料
                    const insertQuery = `INSERT INTO starbucks (name, price, size, time) VALUES (?, ?, ?, ?)`;
                    const data = [
                        ["那提", 120, "中杯", "2025/02/11"],
                        ["那提", 125, "中杯", "2025/02/12"],
                        ["那提", 135, "大杯", "2025/02/11"],
                        ["那提", 140, "大杯", "2025/02/12"],
                        ["那提", 150, "特大杯", "2025/02/11"],
                        ["那提", 155, "特大杯", "2025/02/12"],
                        ["美式", 95, "中杯", "2025/02/11"],
                        ["美式", 100, "中杯", "2025/02/12"],
                        ["美式", 110, "大杯", "2025/02/11"],
                        ["美式", 115, "大杯", "2025/02/12"],
                        ["美式", 125, "特大杯", "2025/02/11"],
                        ["美式", 130, "特大杯", "2025/02/12"],
                        ["焦糖瑪奇朵", 140, "中杯", "2025/02/11"],
                        ["焦糖瑪奇朵", 145, "中杯", "2025/02/12"],
                        ["焦糖瑪奇朵", 155, "大杯", "2025/02/11"],
                        ["焦糖瑪奇朵", 160, "大杯", "2025/02/12"],
                        ["焦糖瑪奇朵", 170, "特大杯", "2025/02/11"],
                        ["焦糖瑪奇朵", 175, "特大杯", "2025/02/12"],
                        ["卡布奇諾", 120, "中杯", "2025/02/11"],
                        ["卡布奇諾", 125, "中杯", "2025/02/12"],
                        ["卡布奇諾", 135, "大杯", "2025/02/11"],
                        ["卡布奇諾", 140, "大杯", "2025/02/12"],
                        ["卡布奇諾", 150, "特大杯", "2025/02/11"],
                        ["卡布奇諾", 155, "特大杯", "2025/02/12"],
                        ["摩卡", 135, "中杯", "2025/02/11"],
                        ["摩卡", 140, "中杯", "2025/02/12"],
                        ["摩卡", 150, "大杯", "2025/02/11"],
                        ["摩卡", 155, "大杯", "2025/02/12"],
                        ["摩卡", 165, "特大杯", "2025/02/11"],
                        ["摩卡", 170, "特大杯", "2025/02/12"],
                        ["特選馥郁那提", 145, "中杯", "2025/02/11"],
                        ["特選馥郁那提", 150, "中杯", "2025/02/12"],
                        ["特選馥郁那提", 160, "大杯", "2025/02/11"],
                        ["特選馥郁那提", 165, "大杯", "2025/02/12"],
                        ["特選馥郁那提", 175, "特大杯", "2025/02/11"],
                        ["特選馥郁那提", 180, "特大杯", "2025/02/12"],
                        ["馥列白", 135, "中杯", "2025/02/11"],
                        ["馥列白", 140, "中杯", "2025/02/12"],
                        ["馥列白", 150, "大杯", "2025/02/11"],
                        ["馥列白", 155, "大杯", "2025/02/12"],
                        ["馥列白", 165, "特大杯", "2025/02/11"],
                        ["馥列白", 170, "特大杯", "2025/02/12"],
                        ["可可瑪奇朵", 140, "中杯", "2025/02/11"],
                        ["可可瑪奇朵", 145, "中杯", "2025/02/12"],
                        ["可可瑪奇朵", 155, "大杯", "2025/02/11"],
                        ["可可瑪奇朵", 160, "大杯", "2025/02/12"],
                        ["可可瑪奇朵", 170, "特大杯", "2025/02/11"],
                        ["可可瑪奇朵", 175, "特大杯", "2025/02/12"],
                        ["雲朵冰搖濃縮咖啡", 130, "中杯", "2025/02/11"],
                        ["雲朵冰搖濃縮咖啡", 135, "中杯", "2025/02/12"],
                        ["雲朵冰搖濃縮咖啡", 145, "大杯", "2025/02/11"],
                        ["雲朵冰搖濃縮咖啡", 150, "大杯", "2025/02/12"],
                        ["雲朵冰搖濃縮咖啡", 160, "特大杯", "2025/02/11"],
                        ["雲朵冰搖濃縮咖啡", 165, "特大杯", "2025/02/12"],
                        ["冰咖啡密斯朵", 85, "中杯", "2025/02/11"],
                        ["冰咖啡密斯朵", 90, "中杯", "2025/02/12"],
                        ["冰咖啡密斯朵", 95, "大杯", "2025/02/11"],
                        ["冰咖啡密斯朵", 100, "大杯", "2025/02/12"],
                        ["冰咖啡密斯朵", 105, "特大杯", "2025/02/11"],
                        ["冰咖啡密斯朵", 110, "特大杯", "2025/02/12"],
                        ["每日精選咖啡", 85, "中杯", "2025/02/11"],
                        ["每日精選咖啡", 90, "中杯", "2025/02/12"],
                        ["每日精選咖啡", 95, "大杯", "2025/02/11"],
                        ["每日精選咖啡", 100, "大杯", "2025/02/12"],
                        ["每日精選咖啡", 105, "特大杯", "2025/02/11"],
                        ["每日精選咖啡", 110, "特大杯", "2025/02/12"]
                    ];

                    data.forEach(row => {
                        db.run(insertQuery, row, (err) => {
                            if (err) {
                                console.error('無法插入資料:', err.message);
                            } else {
                                console.log('成功插入資料:', row);
                            }
                        });
                    });
                }
            });
        }
    });
});

module.exports = db;
